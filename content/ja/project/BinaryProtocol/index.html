<!DOCTYPE html>

<!--

    Licensed to the Apache Software Foundation (ASF) under one
    or more contributor license agreements.  See the NOTICE file
    distributed with this work for additional information
    regarding copyright ownership.  The ASF licenses this file
    to you under the Apache License, Version 2.0 (the
    "License"); you may not use this file except in compliance
    with the License.  You may obtain a copy of the License at

      http://www.apache.org/licenses/LICENSE-2.0

    Unless required by applicable law or agreed to in writing,
    software distributed under the License is distributed on an
    "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
    KIND, either express or implied.  See the License for the
    specific language governing permissions and limitations
    under the License.

-->

<html>
  <head>
    <!--

    Licensed to the Apache Software Foundation (ASF) under one
    or more contributor license agreements.  See the NOTICE file
    distributed with this work for additional information
    regarding copyright ownership.  The ASF licenses this file
    to you under the Apache License, Version 2.0 (the
    "License"); you may not use this file except in compliance
    with the License.  You may obtain a copy of the License at

      http://www.apache.org/licenses/LICENSE-2.0

    Unless required by applicable law or agreed to in writing,
    software distributed under the License is distributed on an
    "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
    KIND, either express or implied.  See the License for the
    specific language governing permissions and limitations
    under the License.

-->
<script type="text/javascript">
  var shiftWindow = function() { scrollBy(0, -108) };
  window.addEventListener("hashchange", shiftWindow);
  window.addEventListener("pageshow", shiftWindow);
  function load() { if (window.location.hash) shiftWindow(); }
</script>

<title>Pulsarのバイナリプロトコルの仕様</title>

<meta charset="utf-8">

<link rel="stylesheet" href="/css/style.css">
<link rel="shortcut icon" href="/img/favicon.ico">

<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/tether/1.4.0/js/tether.min.js"></script>
<script src="https://code.jquery.com/ui/1.12.1/jquery-ui.min.js"></script>
<script src="/js/jquery.tocify.min.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-alpha.6/js/bootstrap.min.js" integrity="sha384-vBWWzlZJ8ea9aCX4pEW3rVHjgjt7zpkNpZk+02D9phzyeVkE+jo0ieGizqPLForn" crossorigin="anonymous"></script>

<script src="/js/jquery.scrollTo.min.js"></script>
<script async src="/js/main.js"></script>

  </head>
  <body class="body">
    <main class="main">
      <!--

    Licensed to the Apache Software Foundation (ASF) under one
    or more contributor license agreements.  See the NOTICE file
    distributed with this work for additional information
    regarding copyright ownership.  The ASF licenses this file
    to you under the Apache License, Version 2.0 (the
    "License"); you may not use this file except in compliance
    with the License.  You may obtain a copy of the License at

      http://www.apache.org/licenses/LICENSE-2.0

    Unless required by applicable law or agreed to in writing,
    software distributed under the License is distributed on an
    "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
    KIND, either express or implied.  See the License for the
    specific language governing permissions and limitations
    under the License.

-->

<nav class="navbar navbar-toggleable-md navbar-light sticky-top">
  <button class="navbar-toggler navbar-toggler-right" type="button" data-toggle="collapse" data-target="#navbarNavDropdown" aria-controls="navbarNavDropdown" aria-expanded="false" aria-label="Toggle navigation">
    <span class="navbar-toggler-icon"></span>
  </button>

  
  <a class="navbar-brand" href="/">
    <img class="main-logo" src="/img/pulsar-logo.png" alt="Pulsar logo">
  </a>
  

  <a class="navbar-nav"></a>

  <div class="collapse navbar-collapse justify-content-end" id="navbarNavDropdown">
    <ul class="navbar-nav">
      <li class="nav-item dropdown">
        <a class="nav-link dropdown-toggle" href="#" id="clientLibsDropdown" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">Documentation</a>

        <div class="dropdown-menu" aria-labelledby="documentationDropdown">
          <a class="dropdown-item" href="/docs/latest/getting-started/LocalCluster">Latest</a>

          <div class="dropdown-divider"></div>
          <h3 class="dropdown-header">Stable release</h3>
          <a class="dropdown-item" href="/docs/v1.20.0-incubating/getting-started/LocalCluster">1.20.0-incubating</a>

          
              <div class="dropdown-divider"></div>
              <h3 class="dropdown-header">Other releases</h3>

              
                  <a class="dropdown-item" href="/docs/v1.19.0-incubating/getting-started/LocalCluster">1.19.0-incubating</a>
              
          
        </div>
      </li>

      <li class="nav-item">
          <a class="nav-link" href="/download">Download</a>
      </li>

      <li class="nav-item dropdown">
        <a class="nav-link dropdown-toggle" href="#" id="clientLibsDropdown" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
          Client libraries
        </a>
        <div class="dropdown-menu" aria-labelledby="clientLibsDropdown">
          <a class="dropdown-item" href="/docs/latest/clients/Java">
            Java
          </a>
          <a class="dropdown-item" href="/docs/latest/clients/Python">
            Python
          </a>
          <a class="dropdown-item" href="/docs/latest/clients/Cpp">
            C++
          </a>
          <div class="dropdown-divider"></div>
          <a class="dropdown-item" href="/api/client">
            Java client Javadoc
          </a>
          <a class="dropdown-item" href="/api/admin">
            Java admin Javadoc
          </a>
          <a class="dropdown-item" href="/api/python">
            Python API docs
          </a>
          <a class="dropdown-item" href="/api/cpp">
            C++ API docs
          </a>
        </div>
      </li>

      <li class="nav-item dropdown">
        <a class="nav-link dropdown-toggle" href="#" id="versionsDropdown" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
          Community
        </a>
        <div class="dropdown-menu dropdown-left" aria-labelledby="versionsDropdown">
          <h3 class="dropdown-header">Get in touch</h3>
          <a class="dropdown-item" href="/contact">Contact</a>
          <a class="dropdown-item" href="https://twitter.com/Apache_Pulsar">Twitter</a>
          <a class="dropdown-item" href="https://github.com/apache/incubator-pulsar/wiki">Wiki</a>
          <a class="dropdown-item" href="https://github.com/apache/incubator-pulsar/issues">Issue tracking</a>
          <div class="dropdown-divider"></div>
          <h3 class="dropdown-header">Resources</h3>
          <a class="dropdown-item" href="/presentations">Presentations</a>
          <a class="dropdown-item" href="/team">Team</a>
          <div class="dropdown-divider"></div>
          <h3 class="dropdown-header">Apache</h3>
          <a class="dropdown-item" href="http://www.apache.org/">The Apache Software Foundation</a>
          <a class="dropdown-item" href="http://www.apache.org/licenses/">License</a>
          <a class="dropdown-item" href="http://www.apache.org/foundation/sponsorship.html">Sponsorship</a>
          <a class="dropdown-item" href="http://www.apache.org/foundation/thanks.html">Thanks</a>
          <a class="dropdown-item" href="http://www.apache.org/security">Security</a>
        </div>
      </li>
    </ul>
  </div>
  <a class="hidden-md-down" href="http://www.apache.org/">
    <img class="asf-logo" title="Apache Software Foundation" src="/img/feather.png" />
  </a>
</nav>

<!--
<nav class="navbar navbar-toggleable-md navbar-light" style="border: 1px solid red;">
  <button class="navbar-toggler navbar-toggler-right" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
    <span class="navbar-toggler-icon"></span>
  </button>

  <a class="navbar-brand" href="/">
    <img src="/img/pulsar-logo.png" class="d-inline-block align-top" alt="Pulsar logo" height="40" width="60">
  </a>

  <div class="collapse navbar-collapse" id="navbarSupportedContent">
    <ul class="navbar-nav mr-auto">
      <li class="nav-item active">
        <a class="nav-link" href="#">Home <span class="sr-only">(current)</span></a>
      </li>
      <li class="nav-item">
        <a class="nav-link" href="#">Link</a>
      </li>
      <li class="nav-item">
        <a class="nav-link disabled" href="#">Disabled</a>
      </li>
    </ul>
  </div>
</nav>-->

      <main>
        <!--

    Licensed to the Apache Software Foundation (ASF) under one
    or more contributor license agreements.  See the NOTICE file
    distributed with this work for additional information
    regarding copyright ownership.  The ASF licenses this file
    to you under the Apache License, Version 2.0 (the
    "License"); you may not use this file except in compliance
    with the License.  You may obtain a copy of the License at

      http://www.apache.org/licenses/LICENSE-2.0

    Unless required by applicable law or agreed to in writing,
    software distributed under the License is distributed on an
    "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
    KIND, either express or implied.  See the License for the
    specific language governing permissions and limitations
    under the License.

-->


<div class="docs-container container-fluid">
  <div class="row">
    <nav class="sidebar-nav hidden-md-down col-lg-3">
      <!--

    Licensed to the Apache Software Foundation (ASF) under one
    or more contributor license agreements.  See the NOTICE file
    distributed with this work for additional information
    regarding copyright ownership.  The ASF licenses this file
    to you under the Apache License, Version 2.0 (the
    "License"); you may not use this file except in compliance
    with the License.  You may obtain a copy of the License at

      http://www.apache.org/licenses/LICENSE-2.0

    Unless required by applicable law or agreed to in writing,
    software distributed under the License is distributed on an
    "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
    KIND, either express or implied.  See the License for the
    specific language governing permissions and limitations
    under the License.

-->


<aside class="sidebar-nav">
  <div id="sidebar-accordion" role="tablist" aria-multiselectable="true">
    
    
    <div class="card">
      <div class="card-header" role="tab" id="heading-入門">
        <h5>
          <a data-toggle="collapse" data-parent="#sidebar-accordion" href="#collapse-入門" aria-controls="collapse-入門">
            入門
          </a>
        </h5>
      </div>

      <div class="sidebar-group collapse" id="collapse-入門" role="tabpanel" aria-labelledby="heading-入門">
        <ul>
          
          
          <li>
            <a href="/ja/getting-started/LocalCluster">
              ローカルでPulsarを起動
            </a>
          </li>
          
          
          <li>
            <a href="/ja/getting-started/Clients">
              クライアントライブラリ
            </a>
          </li>
          
          
          <li>
            <a href="/ja/getting-started/ConceptsAndArchitecture">
              コンセプトとアーキテクチャ
            </a>
          </li>
          
        </ul>
      </div>
    </div>
    
    
    <div class="card">
      <div class="card-header" role="tab" id="heading-デプロイ">
        <h5>
          <a data-toggle="collapse" data-parent="#sidebar-accordion" href="#collapse-デプロイ" aria-controls="collapse-デプロイ">
            デプロイ
          </a>
        </h5>
      </div>

      <div class="sidebar-group collapse" id="collapse-デプロイ" role="tabpanel" aria-labelledby="heading-デプロイ">
        <ul>
          
          
          <li>
            <a href="/ja/deployment/InstanceSetup">
              ベアメタル
            </a>
          </li>
          
          
          <li>
            <a href="/ja/deployment/Kubernetes">
              Kubernetes
            </a>
          </li>
          
          
          <li>
            <a href="/ja/deployment/Kubernetes/#google-container-engine">
              Google Container Engine
            </a>
          </li>
          
          
          <li>
            <a href="/ja/deployment/Kubernetes/#amazon-web-services">
              AWS
            </a>
          </li>
          
          
          <li>
            <a href="/ja/deployment/Monitoring">
              監視
            </a>
          </li>
          
        </ul>
      </div>
    </div>
    
    
    <div class="card">
      <div class="card-header" role="tab" id="heading-管理">
        <h5>
          <a data-toggle="collapse" data-parent="#sidebar-accordion" href="#collapse-管理" aria-controls="collapse-管理">
            管理
          </a>
        </h5>
      </div>

      <div class="sidebar-group collapse" id="collapse-管理" role="tabpanel" aria-labelledby="heading-管理">
        <ul>
          
          
          <li>
            <a href="/ja/admin/AdminInterface">
              Pulsar adminインターフェース
            </a>
          </li>
          
          
          <li>
            <a href="/ja/admin/ClustersBrokers">
              クラスタとBroker
            </a>
          </li>
          
          
          <li>
            <a href="/ja/admin/PropertiesNamespaces">
              プロパティとネームスペース
            </a>
          </li>
          
          
          <li>
            <a href="/ja/admin/ZooKeeperBookKeeper">
              ZooKeeperとBookKeeper
            </a>
          </li>
          
          
          <li>
            <a href="/ja/admin/Dashboard">
              ダッシュボード
            </a>
          </li>
          
          
          <li>
            <a href="/ja/admin/Authz">
              認証と認可
            </a>
          </li>
          
          
          <li>
            <a href="/ja/admin/GeoReplication">
              ジオレプリケーション
            </a>
          </li>
          
          
          <li>
            <a href="/ja/admin/Stats">
              統計情報
            </a>
          </li>
          
          
          <li>
            <a href="/ja/admin/ModularLoadManager">
              モジュラロードマネージャ
            </a>
          </li>
          
        </ul>
      </div>
    </div>
    
    
    <div class="card">
      <div class="card-header" role="tab" id="heading-クライアントライブラリ">
        <h5>
          <a data-toggle="collapse" data-parent="#sidebar-accordion" href="#collapse-クライアントライブラリ" aria-controls="collapse-クライアントライブラリ">
            クライアントライブラリ
          </a>
        </h5>
      </div>

      <div class="sidebar-group collapse" id="collapse-クライアントライブラリ" role="tabpanel" aria-labelledby="heading-クライアントライブラリ">
        <ul>
          
          
          <li>
            <a href="/ja/clients/Java">
              Java
            </a>
          </li>
          
          
          <li>
            <a href="/ja/clients/Cpp">
              C++
            </a>
          </li>
          
          
          <li>
            <a href="/ja/clients/Python">
              Python
            </a>
          </li>
          
          
          <li>
            <a href="/ja/clients/WebSocket">
              WebSocket API
            </a>
          </li>
          
        </ul>
      </div>
    </div>
    
    
    <div class="card">
      <div class="card-header" role="tab" id="heading-アダプタ">
        <h5>
          <a data-toggle="collapse" data-parent="#sidebar-accordion" href="#collapse-アダプタ" aria-controls="collapse-アダプタ">
            アダプタ
          </a>
        </h5>
      </div>

      <div class="sidebar-group collapse" id="collapse-アダプタ" role="tabpanel" aria-labelledby="heading-アダプタ">
        <ul>
          
          
          <li>
            <a href="/ja/adaptors/PulsarSpark">
              Spark Streaming
            </a>
          </li>
          
          
          <li>
            <a href="/ja/adaptors/PulsarStorm">
              Apache Storm
            </a>
          </li>
          
        </ul>
      </div>
    </div>
    
    
    <div class="card">
      <div class="card-header" role="tab" id="heading-高度な機能">
        <h5>
          <a data-toggle="collapse" data-parent="#sidebar-accordion" href="#collapse-高度な機能" aria-controls="collapse-高度な機能">
            高度な機能
          </a>
        </h5>
      </div>

      <div class="sidebar-group collapse" id="collapse-高度な機能" role="tabpanel" aria-labelledby="heading-高度な機能">
        <ul>
          
          
          <li>
            <a href="/ja/advanced/PartitionedTopics">
              パーティションドトピック
            </a>
          </li>
          
          
          <li>
            <a href="/ja/advanced/RetentionExpiry">
              保存と有効期限
            </a>
          </li>
          
        </ul>
      </div>
    </div>
    
    
    <div class="card">
      <div class="card-header" role="tab" id="heading-開発">
        <h5>
          <a data-toggle="collapse" data-parent="#sidebar-accordion" href="#collapse-開発" aria-controls="collapse-開発">
            開発
          </a>
        </h5>
      </div>

      <div class="sidebar-group collapse" id="collapse-開発" role="tabpanel" aria-labelledby="heading-開発">
        <ul>
          
          
          <li>
            <a href="/ja/project/SimulationTools">
              シミュレーションツール
            </a>
          </li>
          
          
          <li>
            <a href="/ja/project/BinaryProtocol">
              バイナリプロトコル
            </a>
          </li>
          
          
          <li>
            <a href="/ja/project/Codebase">
              コードベース
            </a>
          </li>
          
        </ul>
      </div>
    </div>
    
    
    <div class="card">
      <div class="card-header" role="tab" id="heading-リファレンス">
        <h5>
          <a data-toggle="collapse" data-parent="#sidebar-accordion" href="#collapse-リファレンス" aria-controls="collapse-リファレンス">
            リファレンス
          </a>
        </h5>
      </div>

      <div class="sidebar-group collapse" id="collapse-リファレンス" role="tabpanel" aria-labelledby="heading-リファレンス">
        <ul>
          
          
          <li>
            <a href="/ja/reference/RestApi">
              Pulsar REST API
            </a>
          </li>
          
          
          <li>
            <a href="/ja/reference/CliTools">
              コマンドラインツール
            </a>
          </li>
          
          
          <li>
            <a href="/ja/reference/Configuration">
              設定
            </a>
          </li>
          
        </ul>
      </div>
    </div>
    
  </div>
</aside>


    </nav>

    <article class="col-xs-12 col-sm-12 col-md-12 col-lg-7">
      <section class="docs-header">
        <h1 class="docs-title">Pulsarのバイナリプロトコルの仕様</h1>
        
        <section class="tags">
          
          <!-- <span class="badge badge-pill badge-primary">protobuf</span> -->
          <button type="button" class="btn btn-primary" data-toggle="modal" data-target="#modal-protobuf">protobuf</button>
          <!--

    Licensed to the Apache Software Foundation (ASF) under one
    or more contributor license agreements.  See the NOTICE file
    distributed with this work for additional information
    regarding copyright ownership.  The ASF licenses this file
    to you under the Apache License, Version 2.0 (the
    "License"); you may not use this file except in compliance
    with the License.  You may obtain a copy of the License at

      http://www.apache.org/licenses/LICENSE-2.0

    Unless required by applicable law or agreed to in writing,
    software distributed under the License is distributed on an
    "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
    KIND, either express or implied.  See the License for the
    specific language governing permissions and limitations
    under the License.

-->
<div class="modal fade" id="modal-protobuf">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title"><strong>protobuf</strong>タグのページ一覧</h5>
      </div>
      <div class="modal-body">
        <ul>
          
          
          
          
          
          
          
          
          <li><a href="/ja/project/BinaryProtocol/">Pulsarのバイナリプロトコルの仕様</a></li>
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
        </ul>
      </div>
    </div>
  </div>
</div>

          
          <!-- <span class="badge badge-pill badge-primary">binary protocol</span> -->
          <button type="button" class="btn btn-primary" data-toggle="modal" data-target="#modal-binary-protocol">binary protocol</button>
          <!--

    Licensed to the Apache Software Foundation (ASF) under one
    or more contributor license agreements.  See the NOTICE file
    distributed with this work for additional information
    regarding copyright ownership.  The ASF licenses this file
    to you under the Apache License, Version 2.0 (the
    "License"); you may not use this file except in compliance
    with the License.  You may obtain a copy of the License at

      http://www.apache.org/licenses/LICENSE-2.0

    Unless required by applicable law or agreed to in writing,
    software distributed under the License is distributed on an
    "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
    KIND, either express or implied.  See the License for the
    specific language governing permissions and limitations
    under the License.

-->
<div class="modal fade" id="modal-binary-protocol">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title"><strong>binary protocol</strong>タグのページ一覧</h5>
      </div>
      <div class="modal-body">
        <ul>
          
          
          
          
          
          
          
          
          <li><a href="/ja/project/BinaryProtocol/">Pulsarのバイナリプロトコルの仕様</a></li>
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
        </ul>
      </div>
    </div>
  </div>
</div>

          
        </section>

        <hr class="hr">
      </section>

      <section class="content">
        <p>Pulsarは<span class="popover-term" tabindex="0" title="Producerとは？" data-placement="top" data-content="Pulsarのトピックにメッセージを発行するプロセスです。" data-toggle="popover" data-trigger="focus">Producer</span>/<span class="popover-term" tabindex="0" title="Consumerとは？" data-placement="top" data-content="Pulsarのトピックを購読し、Producerによって発行されたメッセージを処理するプロセスです。" data-toggle="popover" data-trigger="focus">Consumer</span>と<span class="popover-term" tabindex="0" title="Brokerとは？" data-placement="top" data-content="2つの異なるコンポーネントを実行するPulsarクラスタのステートレスなコンポーネントです。2つのコンポーネントとは管理操作とトピックルックアップのためのRESTインターフェースを提供するHTTPサーバと全てのメッセージの転送を処理するディスパッチャです。またPulsarクラスタは基本的に複数のBrokerから構成されます。" data-toggle="popover" data-trigger="focus">Broker</span>の通信に独自バイナリプロトコルを利用しています。プロトコルは転送と実装の最大効率を保証しながら、<span class="popover-term" tabindex="0" title="Ack (確認応答) とは？" data-placement="top" data-content="メッセージが正常に処理されたことを知らせるためにConsumerがPulsar Brokerに送信するメッセージのことです。Ackはそのメッセージをシステム上から削除できることをPulsarが知る方法です。もしAckがなければ、そのメッセージは処理されるまで保持されます。" data-toggle="popover" data-trigger="focus">Ack</span> (確認応答) やフロー制御のような要求される全ての機能をサポートするようにデザインされています。</p>

<p>クライアントとBrokerは互いに<em>コマンド</em>を交換します。コマンドは<a href="https://developers.google.com/protocol-buffers/">Protocol Buffers</a> (<em>protobuf</em>) によるバイナリメッセージの形式です。protobufによるコマンドの仕様は<a href="https://github.com/apache/incubator-pulsar/blob/master/pulsar-common/src/main/proto/PulsarApi.proto"><code class="highlighter-rouge">PulsarApi.proto</code></a> に記述されています。また、本ドキュメントの<a href="#protobufインターフェース">Protobufインターフェース</a>セクションにも記述されています。</p>

<!--

    Licensed to the Apache Software Foundation (ASF) under one
    or more contributor license agreements.  See the NOTICE file
    distributed with this work for additional information
    regarding copyright ownership.  The ASF licenses this file
    to you under the Apache License, Version 2.0 (the
    "License"); you may not use this file except in compliance
    with the License.  You may obtain a copy of the License at

      http://www.apache.org/licenses/LICENSE-2.0

    Unless required by applicable law or agreed to in writing,
    software distributed under the License is distributed on an
    "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
    KIND, either express or implied.  See the License for the
    specific language governing permissions and limitations
    under the License.

-->
<div class="admonition">
  <div class="success">
    <span class="admonition-title"><p>接続の共有</p>
</span>
    <p>異なるProducerとConsumerのコマンドは同じ接続を介して制限なく送信、インターリーブできます。</p>

  </div>
</div>

<p>全てのコマンドは<a href="https://developers.google.com/protocol-buffers/docs/proto#enum">enum</a><a href="#pulsar.proto.Type">型</a>と全ての可能なサブコマンドをオプショナルフィールドに含むprotobufのメッセージである<a href="#pulsar.proto.BaseCommand"><code class="highlighter-rouge">BaseCommand</code></a>に埋め込まれています。いかなる時も、1つの<code class="highlighter-rouge">BaseCommand</code>は1つのサブコマンドしか設定できません。</p>

<h2 id="フレーミング">フレーミング</h2>

<p>protobufはいかなるメッセージのフレーミング機能も提供していないため、protobufのデータの前にフレームのサイズを指定する4バイトのフィールドを追加しています。1つのフレームの最大サイズは5 MBです。</p>

<p>Pulsarのプロトコルには以下の2つのタイプのコマンドがあります:</p>
<ol>
  <li>ペイロードを持たない<em>シンプルなコマンド</em>。</li>
  <li>メッセージの配送や発行に使われる<em>ペイロードを持つコマンド</em>。このケースではprotobufのコマンドデータの後に、protobufの<a href="#メッセージメタデータ">メタデータ</a>が追従します。ペイロードはprotobufメッセージの後にRaw形式で渡されます。全てのサイズは4バイト符号なしビッグエンディアン整数として渡されます。</li>
</ol>

<!--

    Licensed to the Apache Software Foundation (ASF) under one
    or more contributor license agreements.  See the NOTICE file
    distributed with this work for additional information
    regarding copyright ownership.  The ASF licenses this file
    to you under the Apache License, Version 2.0 (the
    "License"); you may not use this file except in compliance
    with the License.  You may obtain a copy of the License at

      http://www.apache.org/licenses/LICENSE-2.0

    Unless required by applicable law or agreed to in writing,
    software distributed under the License is distributed on an
    "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
    KIND, either express or implied.  See the License for the
    specific language governing permissions and limitations
    under the License.

-->
<div class="admonition">
  <div class="info">
    
    <p>効率面の理由からペイロードはprotobuf形式ではなくRaw形式で渡されます。</p>

  </div>
</div>

<h4 id="シンプルなコマンド">シンプルなコマンド</h4>

<p>シンプルな (ペイロードのない) コマンドは以下のような構造です:</p>

<script type="math/tex; mode=display">[totalSize][commandSize][message]</script>

<table>
  <thead>
    <tr>
      <th style="text-align: left">コンポーネント</th>
      <th style="text-align: left">説明</th>
      <th style="text-align: left">サイズ (バイト)</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: left">totalSize</td>
      <td style="text-align: left">フレームのサイズ (バイト), その後に続く全てのデータを数えます</td>
      <td style="text-align: left">4</td>
    </tr>
    <tr>
      <td style="text-align: left">commandSize</td>
      <td style="text-align: left">シリアライズされたprotobufのコマンドのサイズ</td>
      <td style="text-align: left">4</td>
    </tr>
    <tr>
      <td style="text-align: left">message</td>
      <td style="text-align: left">Rawバイナリ形式 (protobuf形式ではなく) でシリアライズされたprotobufメッセージ</td>
      <td style="text-align: left"> </td>
    </tr>
  </tbody>
</table>

<h4 id="ペイロードを持つコマンド">ペイロードを持つコマンド</h4>

<p>ペイロードコマンドは以下のような構造です:</p>

<script type="math/tex; mode=display">[totalSize][commandSize][message][magicNumber][checksum][metadataSize][metadata][payload]</script>

<table>
  <thead>
    <tr>
      <th style="text-align: left">コンポーネント</th>
      <th style="text-align: left">説明</th>
      <th style="text-align: left">サイズ (バイト)</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: left">totalSize</td>
      <td style="text-align: left">フレームのサイズ (バイト), その後に続く全てのデータを数えます</td>
      <td style="text-align: left">4</td>
    </tr>
    <tr>
      <td style="text-align: left">commandSize</td>
      <td style="text-align: left">シリアライズされたprotobufのコマンドのサイズ</td>
      <td style="text-align: left">4</td>
    </tr>
    <tr>
      <td style="text-align: left">message</td>
      <td style="text-align: left">Rawバイナリ形式 (protobuf形式ではなく) でシリアライズされたprotobufメッセージ</td>
      <td style="text-align: left"> </td>
    </tr>
    <tr>
      <td style="text-align: left">magicNumber</td>
      <td style="text-align: left">(<code class="highlighter-rouge">0x0e01</code>) 現在のフォーマットを特定する2バイトのマジックナンバー</td>
      <td style="text-align: left">2</td>
    </tr>
    <tr>
      <td style="text-align: left">checksum</td>
      <td style="text-align: left">この後に続くデータに対する<a href="http://www.evanjones.ca/crc32c.html">CRC32-Cチェックサム</a></td>
      <td style="text-align: left">4</td>
    </tr>
    <tr>
      <td style="text-align: left">metadataSize</td>
      <td style="text-align: left">メッセージ・<a href="#メッセージメタデータ">メタデータ</a>のサイズ</td>
      <td style="text-align: left">4</td>
    </tr>
    <tr>
      <td style="text-align: left">metadata</td>
      <td style="text-align: left">protobufによるバイナリメッセージの形式のメッセージ・<a href="#メッセージメタデータ">メタデータ</a></td>
      <td style="text-align: left"> </td>
    </tr>
    <tr>
      <td style="text-align: left">payload</td>
      <td style="text-align: left">フレームの残りの部分はペイロードとみなされます、任意のバイト列を含めることができます</td>
      <td style="text-align: left"> </td>
    </tr>
  </tbody>
</table>

<h2 id="メッセージメタデータ">メッセージ・メタデータ</h2>

<p>メッセージ・メタデータは、アプリケーションに指定されたペイロードとともに、シリアライズされたprotobufメッセージとして保存されます。メタデータは<span class="popover-term" tabindex="0" title="Producerとは？" data-placement="top" data-content="Pulsarのトピックにメッセージを発行するプロセスです。" data-toggle="popover" data-trigger="focus">Producer</span>によって作成され、変更されずに<span class="popover-term" tabindex="0" title="Consumerとは？" data-placement="top" data-content="Pulsarのトピックを購読し、Producerによって発行されたメッセージを処理するプロセスです。" data-toggle="popover" data-trigger="focus">Consumer</span>に渡されます。</p>

<table>
  <thead>
    <tr>
      <th style="text-align: left">フィールド</th>
      <th style="text-align: left">説明</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: left"><code class="highlighter-rouge">producer_name</code></td>
      <td style="text-align: left">メッセージを発行した<span class="popover-term" tabindex="0" title="Producerとは？" data-placement="top" data-content="Pulsarのトピックにメッセージを発行するプロセスです。" data-toggle="popover" data-trigger="focus">Producer</span>の名前</td>
    </tr>
    <tr>
      <td style="text-align: left"><code class="highlighter-rouge">sequence_id</code></td>
      <td style="text-align: left"><span class="popover-term" tabindex="0" title="Producerとは？" data-placement="top" data-content="Pulsarのトピックにメッセージを発行するプロセスです。" data-toggle="popover" data-trigger="focus">Producer</span>から割り当てられたメッセージのシーケンスID</td>
    </tr>
    <tr>
      <td style="text-align: left"><code class="highlighter-rouge">publish_time</code></td>
      <td style="text-align: left">発行時のタイムスタンプ (UTCで1970年1月1日からのミリ秒単位の経過時間)</td>
    </tr>
    <tr>
      <td style="text-align: left"><code class="highlighter-rouge">properties</code></td>
      <td style="text-align: left">Key-Valueペアのシーケンス (<a href="https://github.com/apache/incubator-pulsar/blob/master/pulsar-common/src/main/proto/PulsarApi.proto#L32"><code class="highlighter-rouge">KeyValue</code></a>メッセージを使用)。アプリケーションに定義されたKey-ValueでPulsarの動作には影響を与えません。</td>
    </tr>
    <tr>
      <td style="text-align: left"><code class="highlighter-rouge">replicated_from</code> <em>(任意)</em></td>
      <td style="text-align: left">メッセージがレプリケートされたものかを表し、レプリケートされたものである場合レプリケート元の<span class="popover-term" tabindex="0" title="クラスタとは？" data-placement="top" data-content="Pulsar BrokerとBookKeeperサーバ (Bookie) のセットのことです。それぞれのクラスタは異なる地理的地域に存在することができ、メッセージをクラスタ間で相互に複製することができます。この機能をジオレプリケーションと呼びます。" data-toggle="popover" data-trigger="focus">クラスタ</span>名を示します。</td>
    </tr>
    <tr>
      <td style="text-align: left"><code class="highlighter-rouge">partition_key</code> <em>(任意)</em></td>
      <td style="text-align: left">パーティションドトピックに発行される場合、キーが存在すればそのハッシュをパーティションの選択に利用します。</td>
    </tr>
    <tr>
      <td style="text-align: left"><code class="highlighter-rouge">compression</code> <em>(任意)</em></td>
      <td style="text-align: left">ペイロードが圧縮されているか、どの圧縮ライブラリが使用されているか</td>
    </tr>
    <tr>
      <td style="text-align: left"><code class="highlighter-rouge">uncompressed_size</code> <em>(任意)</em></td>
      <td style="text-align: left">圧縮されている場合、Producerはこのフィールドに元のペイロードサイズを記述する必要があります。</td>
    </tr>
    <tr>
      <td style="text-align: left"><code class="highlighter-rouge">num_messages_in_batch</code> <em>(任意)</em></td>
      <td style="text-align: left">このメッセージが複数のメッセージの<a href="#バッチメッセージ">バッチ</a>である場合は、含まれているメッセージの数が記述されている必要があります。</td>
    </tr>
  </tbody>
</table>

<h3 id="バッチメッセージ">バッチ・メッセージ</h3>

<p>バッチ・メッセージを利用する時、ペイロードはエントリのリストを含んでいます。それらは<code class="highlighter-rouge">SingleMessageMetadata</code>により定義された固有のメタデータを持ちます。</p>

<p>1つのバッチのペイロードは以下の通りです:</p>

<script type="math/tex; mode=display">[metadataSize1][metadata1][payload1] [metadataSize2][metadata2][payload2] \dots</script>

<table>
  <thead>
    <tr>
      <th style="text-align: left">フィールド</th>
      <th style="text-align: left">説明</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: left">metadataSizeN</td>
      <td style="text-align: left">シリアライズされたprotobuf形式のシングル・メッセージ・メタデータのサイズ</td>
    </tr>
    <tr>
      <td style="text-align: left">metadataN</td>
      <td style="text-align: left">シングル・メッセージ・メタデータ</td>
    </tr>
    <tr>
      <td style="text-align: left">payloadN</td>
      <td style="text-align: left">アプリケーションから渡されたメッセージペイロード</td>
    </tr>
  </tbody>
</table>

<p>各メタデータのフィールドは以下のとおりです:</p>

<table>
  <thead>
    <tr>
      <th style="text-align: left">フィールド</th>
      <th style="text-align: left">説明</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: left">properties</td>
      <td style="text-align: left">アプリケーションが定義したプロパティ</td>
    </tr>
    <tr>
      <td style="text-align: left">partition key <em>(任意)</em></td>
      <td style="text-align: left">ハッシュによりパーティションを特定するためのKey</td>
    </tr>
    <tr>
      <td style="text-align: left">payload_size</td>
      <td style="text-align: left">バッチ内の1つのメッセージについてのペイロードのサイズ</td>
    </tr>
  </tbody>
</table>

<p>圧縮が有効な場合、バッチ全体が一度に圧縮されます。</p>

<h2 id="インタラクション">インタラクション</h2>

<h3 id="接続の確立">接続の確立</h3>

<p>BrokerへのTCPコネクションの確立後、クライアントはセッションを開始しなければなりません。通常これには6650番のポートが利用されます。</p>

<p><img src="/img/Binary%20Protocol%20-%20Connect.png" alt="接続のインタラクション" /></p>

<p>Brokerから<code class="highlighter-rouge">Connected</code>という応答を受け取ると、クライアントは接続準備完了とみなします。もしBrokerがクライアントの認証を検証できなれければ、代わりに<code class="highlighter-rouge">Error</code>コマンドを返しTCPコネクションをクローズします。</p>

<p>例:</p>

<div class="language-protobuf highlighter-rouge"><pre class="highlight"><code><span class="kd">message</span> <span class="nc">CommandConnect</span> <span class="p">{</span>
  <span class="s">"client_version"</span> <span class="o">:</span> <span class="s">"Pulsar-Client-Java-v1.15.2"</span><span class="p">,</span>
  <span class="s">"auth_method_name"</span> <span class="o">:</span> <span class="s">"my-authentication-plugin"</span><span class="p">,</span>
  <span class="s">"auth_data"</span> <span class="o">:</span> <span class="s">"my-auth-data"</span><span class="p">,</span>
  <span class="s">"protocol_version"</span> <span class="o">:</span> <span class="mi">6</span>
<span class="p">}</span>
</code></pre>
</div>

<p>フィールド:</p>
<ul>
  <li><code class="highlighter-rouge">client_version</code> → フォーマットの強制されていないString形式の識別子。</li>
  <li><code class="highlighter-rouge">auth_method_name</code> → <em>(任意)</em> 認証が有効な場合は認証プラグインの名前。</li>
  <li><code class="highlighter-rouge">auth_data</code> → <em>(任意)</em> プラグイン固有の認証データ。</li>
  <li><code class="highlighter-rouge">protocol_version</code> → クライアントのサポートするプロトコルのバージョン。<br />
 Brokerは指定されたバージョンより新しいプロトコルのコマンドを送りません。<br />
 Brokerは最低限のバージョンを要求する可能性があります。</li>
</ul>

<div class="language-protobuf highlighter-rouge"><pre class="highlight"><code><span class="kd">message</span> <span class="nc">CommandConnected</span> <span class="p">{</span>
  <span class="s">"server_version"</span> <span class="o">:</span> <span class="s">"Pulsar-Broker-v1.15.2"</span><span class="p">,</span>
  <span class="s">"protocol_version"</span> <span class="o">:</span> <span class="mi">6</span>
<span class="p">}</span>
</code></pre>
</div>

<p>フィールド:</p>
<ul>
  <li><code class="highlighter-rouge">server_version</code> → BrokerのバージョンのString形式の識別子。</li>
  <li><code class="highlighter-rouge">protocol_version</code> → Brokerがサポートするプロトコルのバージョン。<br />
 クライアントは指定されたバージョンより新しいプロトコルのコマンドを送ることができません。</li>
</ul>

<h3 id="keep-alive">Keep Alive</h3>

<p>クライアントとBrokerの長期のネットワークのパーティションやリモートエンドでのTCPコネクションを終了しないままマシンがクラッシュした場合(例: 停電、カーネルパニック、ハードリブート) を識別するため、リモートピアのアベイラビリティステータスを調べる仕組みが備わっています。</p>

<p>クライアントとBrokerは<code class="highlighter-rouge">Ping</code>コマンド定期的に送信し、タイムアウト時間内 (Brokerが使用するデフォルトの値は60秒)に<code class="highlighter-rouge">Pong</code>レスポンスを受け取らなければソケットをクローズします。</p>

<p>Pulsarクライアントの実装において、<code class="highlighter-rouge">Ping</code>の送信は必須ではありません。しかし、Brokerから強制的にTCPコネクションを終了されないために、<code class="highlighter-rouge">Ping</code>を受け取った場合は迅速な返答が必要です。</p>

<h3 id="producer">Producer</h3>

<p>メッセージを送るために、クライアントはProducerを作成する必要があります。Producerを作成する時、Brokerは最初にそのクライアントがトピックへの発行を認可されているかを検証します。</p>

<p>クライアントがProducerの作成を完了すると、ネゴシエートされたProducer IDを参照してBrokerにメッセージを発行できます。</p>

<p><img src="/img/Binary%20Protocol%20-%20Producer.png" alt="Producerのインタラクション" /></p>

<h5 id="producerコマンド">Producerコマンド</h5>

<div class="language-protobuf highlighter-rouge"><pre class="highlight"><code><span class="kd">message</span> <span class="nc">CommandProducer</span> <span class="p">{</span>
  <span class="s">"topic"</span> <span class="o">:</span> <span class="s">"persistent://my-property/my-cluster/my-namespace/my-topic"</span><span class="p">,</span>
  <span class="s">"producer_id"</span> <span class="o">:</span> <span class="mi">1</span><span class="p">,</span>
  <span class="s">"request_id"</span> <span class="o">:</span> <span class="mi">1</span>
<span class="p">}</span>
</code></pre>
</div>

<p>パラメータ:</p>
<ul>
  <li><code class="highlighter-rouge">topic</code> → Producerを作成したいトピックの完全な名前</li>
  <li><code class="highlighter-rouge">producer_id</code> → クライアントが生成した同一接続内で一意に定まるProducerの識別子。</li>
  <li><code class="highlighter-rouge">request_id</code> → レスポンスのマッチングに用いる同一接続内で一意に定まるリクエストの識別子。</li>
  <li><code class="highlighter-rouge">producer_name</code> → <em>(任意)</em> Producer名が指定されていればそれが利用され、そうでなければ、Brokerが一意に定まる名前を生成します。
 生成されたProducer名はグローバルで一意に定まることが保証されます。<br />
 Producerが最初に作成された時、Brokerに新しいProducer名を作成させ、再接続後にProducerを再作成する時は再利用するという実装が期待されます。</li>
</ul>

<p>Brokerは<code class="highlighter-rouge">ProducerSuccess</code>コマンドか<code class="highlighter-rouge">Error</code>コマンドを返します。</p>

<h5 id="producersuccessコマンド">ProducerSuccessコマンド</h5>

<div class="language-protobuf highlighter-rouge"><pre class="highlight"><code><span class="kd">message</span> <span class="nc">CommandProducerSuccess</span> <span class="p">{</span>
  <span class="s">"request_id"</span> <span class="o">:</span>  <span class="mi">1</span><span class="p">,</span>
  <span class="s">"producer_name"</span> <span class="o">:</span> <span class="s">"generated-unique-producer-name"</span>
<span class="p">}</span>
</code></pre>
</div>

<p>パラメータ:</p>
<ul>
  <li><code class="highlighter-rouge">request_id</code> → <code class="highlighter-rouge">CreateProducer</code>リクエストのID。</li>
  <li><code class="highlighter-rouge">producer_name</code> → 生成されたグローバルで一意に定まるProducer名、もしくはクライアントにより指定された名前。</li>
</ul>

<h5 id="sendコマンド">Sendコマンド</h5>

<p><code class="highlighter-rouge">Send</code>コマンドは既に存在するProducerのコンテキスト内で新しいメッセージを発行する時に使用されます。このコマンドはコマンドだけでなくペイロードを含むフレーム内で使用されます。ペイロードは<a href="#ペイロードを持つコマンド">ペイロードを持つコマンド</a>のセクションに記されている完全なフォーマットで記述されます。</p>

<div class="language-protobuf highlighter-rouge"><pre class="highlight"><code><span class="kd">message</span> <span class="nc">CommandSend</span> <span class="p">{</span>
  <span class="s">"producer_id"</span> <span class="o">:</span> <span class="mi">1</span><span class="p">,</span>
  <span class="s">"sequence_id"</span> <span class="o">:</span> <span class="mi">0</span><span class="p">,</span>
  <span class="s">"num_messages"</span> <span class="o">:</span> <span class="mi">1</span>
<span class="p">}</span>
</code></pre>
</div>

<p>パラメータ:</p>
<ul>
  <li><code class="highlighter-rouge">producer_id</code> → ProducerのID。</li>
  <li><code class="highlighter-rouge">sequence_id</code> → 各メッセージは関連する0からカウントが始まるような実装が期待されるシーケンスのIDを持ちます。  <br />
 メッセージの効果的な発行を承認する<code class="highlighter-rouge">SendReceipt</code>は、シーケンスIDによってメッセージを参照します。</li>
  <li><code class="highlighter-rouge">num_messages</code> → <em>(任意)</em> バッチ・メッセージが発行される時に使用されます。</li>
</ul>

<h5 id="sendreceiptコマンド">SendReceiptコマンド</h5>

<p>メッセージが設定されたレプリカの数に応じて永続化されたあと、BrokerはProducerにメッセージを受け取ったことを示すAckを返します。</p>

<div class="language-protobuf highlighter-rouge"><pre class="highlight"><code><span class="kd">message</span> <span class="nc">CommandSendReceipt</span> <span class="p">{</span>
  <span class="s">"producer_id"</span> <span class="o">:</span> <span class="mi">1</span><span class="p">,</span>
  <span class="s">"sequence_id"</span> <span class="o">:</span> <span class="mi">0</span><span class="p">,</span>
  <span class="s">"message_id"</span> <span class="o">:</span> <span class="p">{</span>
    <span class="s">"ledgerId"</span> <span class="o">:</span> <span class="mi">123</span><span class="p">,</span>
    <span class="s">"entryId"</span> <span class="o">:</span> <span class="mi">456</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre>
</div>

<p>パラメータ:</p>
<ul>
  <li><code class="highlighter-rouge">producer_id</code> → ProducerのID。</li>
  <li><code class="highlighter-rouge">sequence_id</code> → 発行されたメッセージのシーケンスのID。</li>
  <li><code class="highlighter-rouge">message_id</code> → システムに割り当てられた1つのクラスタ内で一意に定まるメッセージのID。<br />
 メッセージIDは<code class="highlighter-rouge">ledgerId</code>と<code class="highlighter-rouge">entryId</code>の2つのlong値から構成されます。<br />
     これらの値はBookKeeperのLedgerに追加された時に割り振られたIDに基づいています。</li>
</ul>

<h5 id="closeproducerコマンド">CloseProducerコマンド</h5>

<p><strong>注</strong>: <em>このコマンドはProducerとBrokerの両方から送信される可能性があります</em>。</p>

<p>Brokerが<code class="highlighter-rouge">CloseProducer</code>コマンドを受け取った時、BrokerはProducerからそれ以上のメッセージの受信を停止し、ペンディング中の全てのメッセージが永続化されるまで待ち、クライアントに<code class="highlighter-rouge">Success</code>を返します。</p>

<p>Brokerは、正常なフェイルオーバー (例: Brokerの再起動中、またはトピックが別のBrokerに転送されるようにロードバランサによってアンロードされている場合など) を実行している時、クライアントに<code class="highlighter-rouge">CloseProducer</code>コマンドを送ることができます。</p>

<p>Producerが<code class="highlighter-rouge">CloseProducer</code>コマンドを受け取った時、クライアントはサービスディスカバリ・ルックアップを通じてProducerを再作成することが期待されます。この際TCPコネクションは影響を受けません。</p>

<h3 id="consumer">Consumer</h3>

<p>Consumerはサブスクリプションへの接続とそこからのメッセージのconsumeに利用されます。接続後、クライアントはトピックを購読する必要があります。もしサブスクリプションがそのトピックになければ、新しく作成されます。</p>

<p><img src="/img/Binary%20Protocol%20-%20Consumer.png" alt="Consumer" /></p>

<h4 id="フロー制御">フロー制御</h4>

<p>Consumerの準備が整ったあと、クライアントはBrokerにメッセージをプッシュするための<em>パーミッションを与える</em>必要があります。これは<code class="highlighter-rouge">Flow</code>コマンドによって成されます。</p>

<p><code class="highlighter-rouge">Flow</code>コマンドは追加の<em>パーミッション</em>を与えます。一般的なConsumerの実装では、アプリケーションがメッセージをconsumeする準備が整うまでのメッセージの蓄積にキューを利用します。</p>

<p>アプリケーションがメッセージをデキューしたあと、ConsumerはBrokerに対してさらなるメッセージをプッシュするパーミッションを送ります。</p>

<h5 id="subscribeコマンド">Subscribeコマンド</h5>

<div class="language-protobuf highlighter-rouge"><pre class="highlight"><code><span class="kd">message</span> <span class="nc">CommandSubscribe</span> <span class="p">{</span>
  <span class="s">"topic"</span> <span class="o">:</span> <span class="s">"persistent://my-property/my-cluster/my-namespace/my-topic"</span><span class="p">,</span>
  <span class="s">"subscription"</span> <span class="o">:</span> <span class="s">"my-subscription-name"</span><span class="p">,</span>
  <span class="s">"subType"</span> <span class="o">:</span> <span class="s">"Exclusive"</span><span class="p">,</span>
  <span class="s">"consumer_id"</span> <span class="o">:</span> <span class="mi">1</span><span class="p">,</span>
  <span class="s">"request_id"</span> <span class="o">:</span> <span class="mi">1</span>
<span class="p">}</span>
</code></pre>
</div>

<p>パラメータ:</p>
<ul>
  <li><code class="highlighter-rouge">topic</code> → Consumerを作成したいトピックの完全な名前。</li>
  <li><code class="highlighter-rouge">subscription</code> → サブスクリプション名。</li>
  <li><code class="highlighter-rouge">subType</code> → サブスクリプションタイプ: Exclusive, Shared, Failover</li>
  <li><code class="highlighter-rouge">consumer_id</code> → クライアントが生成した同一接続内で一意に定まるConsumerの識別子。</li>
  <li><code class="highlighter-rouge">request_id</code> → レスポンスのマッチングに用いる同一接続内で一意に定まるリクエストの識別子。</li>
  <li><code class="highlighter-rouge">consumer_name</code> → <em>(任意)</em> クライアントはConsumer名を指定できます。<br />
 この名前は、統計情報で特定のConsumerを追跡するのに利用されます。<br />
 また、サブスクリプションタイプがFailoverの時、この名前はどのConsumerが <em>master</em> (メッセージを受け取るConsumer) となるかを決めるのに使用されます。<br />
 ConsumerはConsumer名によってソートされ、最初のものがmasterとして選ばれます。</li>
</ul>

<h5 id="flowコマンド">Flowコマンド</h5>

<div class="language-protobuf highlighter-rouge"><pre class="highlight"><code><span class="kd">message</span> <span class="nc">CommandFlow</span> <span class="p">{</span>
  <span class="s">"consumer_id"</span> <span class="o">:</span> <span class="mi">1</span><span class="p">,</span>
  <span class="s">"messagePermits"</span> <span class="o">:</span> <span class="mi">1000</span>
<span class="p">}</span>
</code></pre>
</div>

<p>パラメータ:</p>
<ul>
  <li><code class="highlighter-rouge">consumer_id</code> → ConsumerのID。</li>
  <li><code class="highlighter-rouge">messagePermits</code> → Brokerに対して追加でプッシュを許可するメッセージの数。</li>
</ul>

<h5 id="messageコマンド">Messageコマンド</h5>

<p><code class="highlighter-rouge">Message</code>コマンドはBrokerが、与えられたパーミッションの制限内でConsumerにメッセージをプッシュする際に使用されます。</p>

<p>このコマンドはコマンドだけでなくペイロードを含むフレーム内で使用されます。ペイロードは<a href="#ペイロードを持つコマンド">ペイロードを持つコマンド</a>のセクションに記されている完全なフォーマットで記述されます。</p>

<div class="language-protobuf highlighter-rouge"><pre class="highlight"><code><span class="kd">message</span> <span class="nc">CommandMessage</span> <span class="p">{</span>
  <span class="s">"consumer_id"</span> <span class="o">:</span> <span class="mi">1</span><span class="p">,</span>
  <span class="s">"message_id"</span> <span class="o">:</span> <span class="p">{</span>
    <span class="s">"ledgerId"</span> <span class="o">:</span> <span class="mi">123</span><span class="p">,</span>
    <span class="s">"entryId"</span> <span class="o">:</span> <span class="mi">456</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre>
</div>

<h4 id="ackコマンド">Ackコマンド</h4>

<p><code class="highlighter-rouge">Ack</code>コマンドは与えられたメッセージがアプリケーションによって正しく処理され、Brokerによる破棄が可能であるというBrokerへの信号です。</p>

<p>加えて、Brokerは<code class="highlighter-rouge">Ack</code>の返されたメッセージに基いてConsumerの購読位置を管理します。</p>

<div class="language-protobuf highlighter-rouge"><pre class="highlight"><code><span class="kd">message</span> <span class="nc">CommandAck</span> <span class="p">{</span>
  <span class="s">"consumer_id"</span> <span class="o">:</span> <span class="mi">1</span><span class="p">,</span>
  <span class="s">"ack_type"</span> <span class="o">:</span> <span class="s">"Individual"</span><span class="p">,</span>
  <span class="s">"message_id"</span> <span class="o">:</span> <span class="p">{</span>
    <span class="s">"ledgerId"</span> <span class="o">:</span> <span class="mi">123</span><span class="p">,</span>
    <span class="s">"entryId"</span> <span class="o">:</span> <span class="mi">456</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre>
</div>

<p>パラメータ:</p>
<ul>
  <li><code class="highlighter-rouge">consumer_id</code> → ConsumerのID。</li>
  <li><code class="highlighter-rouge">ack_type</code> → Ackのタイプ: <code class="highlighter-rouge">Individual</code> もしくは <code class="highlighter-rouge">Cumulative</code></li>
  <li><code class="highlighter-rouge">message_id</code> → メッセージのID。</li>
  <li><code class="highlighter-rouge">validation_error</code> → <em>(任意)</em> Consumerが次の理由のためメッセージを破棄したことを示します: <code class="highlighter-rouge">UncompressedSizeCorruption</code>,
<code class="highlighter-rouge">DecompressionError</code>, <code class="highlighter-rouge">ChecksumMismatch</code>, <code class="highlighter-rouge">BatchDeSerializeError</code></li>
</ul>

<h5 id="closeconsumerコマンド">CloseConsumerコマンド</h5>

<p><strong><em>注</em></strong>: <em>このコマンドはConsumerとBrokerの両方から送信される可能性があります</em>。</p>

<p>このコマンドは<a href="#closeproducerコマンド"><code class="highlighter-rouge">CloseProducer</code></a>と同様の振る舞いをします。</p>

<h5 id="redeliverunacknowledgedmessagesコマンド">RedeliverUnacknowledgedMessagesコマンド</h5>

<p>ConsumerはBrokerに、特定のConsumerにプッシュしたがまだAckが返っていないメッセージの再配送を要求できます。</p>

<p>そのprotobufメッセージはConsumerが再配送してほしいメッセージのIDのリストから構成されます。リストが空の場合は、Brokerはペンディング中の全てのメッセージを再送します。</p>

<p>再配送において、メッセージは同一のConsumer、あるいはサブスクリプションタイプがSharedの場合は全ての利用可能なConsumerに送信されます。</p>

<h5 id="reachedendoftopicコマンド">ReachedEndOfTopicコマンド</h5>

<p>トピックが”終了”しサブスクリプション上の全てのメッセージにAckが返された際に、そのConsumerに対してBrokerから送信されます。　</p>

<p>クライアントはアプリケーションにこれ以上Consumerからメッセージが来ないことを通知するためにこのコマンドを使用します。</p>

<h2 id="サービスディスカバリ">サービスディスカバリ</h2>

<h3 id="トピックのルックアップ">トピックのルックアップ</h3>

<p>トピックのルックアップはクライアントがProducer, Consumerを作成、再接続する度に必要となります。ルックアップはどのBrokerが、利用しようとしているトピックを提供しているかを見つけるのに使用されます。</p>

<p>ルックアップは<a href="../../admin/AdminInterface#トピックのルックアップ">admin API</a>で
説明されているREST APIのコールで行うことが可能です。</p>

<p>Pulsar-1.16からは、バイナリプロトコルで行うことも可能です。</p>

<p>例として、サービスディスカバリコンポーネントを<code class="highlighter-rouge">pulsar://broker.example.com:6650</code>で起動していると仮定します。</p>

<p>個別のBrokerは<code class="highlighter-rouge">pulsar://broker-1.example.com:6650</code>,
<code class="highlighter-rouge">pulsar://broker-2.example.com:6650</code>, …で起動しています。</p>

<p>クライアントはサービスディスカバリへの接続を<code class="highlighter-rouge">LookupTopic</code>コマンドを送るために利用できます。レスポンスは接続すべきBrokerのホスト名、あるいはルックアップをリトライするためのBrokerのホスト名のどちらかです。</p>

<p><code class="highlighter-rouge">LookupTopic</code>コマンドは<code class="highlighter-rouge">Connect</code> / <code class="highlighter-rouge">Connected</code>の最初のハンドシェイクを終えた接続で使用されなければなりません。</p>

<p><img src="/img/Binary%20Protocol%20-%20Topic%20lookup.png" alt="トピックのルックアップ" /></p>

<div class="language-protobuf highlighter-rouge"><pre class="highlight"><code><span class="kd">message</span> <span class="nc">CommandLookupTopic</span> <span class="p">{</span>
  <span class="s">"topic"</span> <span class="o">:</span> <span class="s">"persistent://my-property/my-cluster/my-namespace/my-topic"</span><span class="p">,</span>
  <span class="s">"request_id"</span> <span class="o">:</span> <span class="mi">1</span><span class="p">,</span>
  <span class="s">"authoritative"</span> <span class="o">:</span> <span class="kc">false</span>
<span class="p">}</span>
</code></pre>
</div>

<p>フィールド:</p>
<ul>
  <li><code class="highlighter-rouge">topic</code> → ルックアップするトピックの名前。</li>
  <li><code class="highlighter-rouge">request_id</code> → レスポンスとともに受け取るリクエストのID。</li>
  <li><code class="highlighter-rouge">authoritative</code> → 最初のルックアップリクエストではfalse、その後に続くリダイレクトのレスポンスではクライアントはレスポンスに含まれているものと同じ値を渡すべきです。</li>
</ul>

<h5 id="lookuptopicresponse">LookupTopicResponse</h5>

<p>成功時のレスポンス例:</p>

<div class="language-protobuf highlighter-rouge"><pre class="highlight"><code><span class="kd">message</span> <span class="nc">CommandLookupTopicResponse</span> <span class="p">{</span>
  <span class="s">"request_id"</span> <span class="o">:</span> <span class="mi">1</span><span class="p">,</span>
  <span class="s">"response"</span> <span class="o">:</span> <span class="s">"Connect"</span><span class="p">,</span>
  <span class="s">"brokerServiceUrl"</span> <span class="o">:</span> <span class="s">"pulsar://broker-1.example.com:6650"</span><span class="p">,</span>
  <span class="s">"brokerServiceUrlTls"</span> <span class="o">:</span> <span class="s">"pulsar+ssl://broker-1.example.com:6651"</span><span class="p">,</span>
  <span class="s">"authoritative"</span> <span class="o">:</span> <span class="kc">true</span>
<span class="p">}</span>
</code></pre>
</div>

<p>リダイレクト時のレスポンス例:</p>

<div class="language-protobuf highlighter-rouge"><pre class="highlight"><code><span class="kd">message</span> <span class="nc">CommandLookupTopicResponse</span> <span class="p">{</span>
  <span class="s">"request_id"</span> <span class="o">:</span> <span class="mi">1</span><span class="p">,</span>
  <span class="s">"response"</span> <span class="o">:</span> <span class="s">"Redirect"</span><span class="p">,</span>
  <span class="s">"brokerServiceUrl"</span> <span class="o">:</span> <span class="s">"pulsar://broker-2.example.com:6650"</span><span class="p">,</span>
  <span class="s">"brokerServiceUrlTls"</span> <span class="o">:</span> <span class="s">"pulsar+ssl://broker-2.example.com:6651"</span><span class="p">,</span>
  <span class="s">"authoritative"</span> <span class="o">:</span> <span class="kc">true</span>
<span class="p">}</span>
</code></pre>
</div>

<p>後者の場合、<code class="highlighter-rouge">LookupTopic</code>コマンドリクエストを<code class="highlighter-rouge">broker-2.example.com</code> に対して再発行する必要があります。このBrokerはルックアップリクエストに対して決定的なレスポンスを返すことができます。</p>

<h3 id="パーティションドトピックのディスカバリ">パーティションドトピックのディスカバリ</h3>

<p>パーティションドトピックのメタデータのディスカバリはトピックがパーティションドトピックかどうか、いくつのパーティションがセットアップされているかを調べるのに利用されます。</p>

<p>トピックがパーティションドである場合、クライアントは<code class="highlighter-rouge">partition-X</code>というサフィックスを用いて各パーティションにつき一つのProducerあるいはConsumerを作成することが期待されます。</p>

<p>この情報は最初にProducerあるいはConsumerが作成される時のみに利用されます。再接続後は必要ありません。</p>

<p>パーティションドトピック・メタデータのディスカバリはトピックのルックアップと非常によく似た働きをします。クライアントはサービスディスカバリに対してリクエストを送り、レスポンスには実際のメタデータが含まれます。</p>

<h5 id="partitionedtopicmetadataコマンド">PartitionedTopicMetadataコマンド</h5>

<div class="language-protobuf highlighter-rouge"><pre class="highlight"><code><span class="kd">message</span> <span class="nc">CommandPartitionedTopicMetadata</span> <span class="p">{</span>
  <span class="s">"topic"</span> <span class="o">:</span> <span class="s">"persistent://my-property/my-cluster/my-namespace/my-topic"</span><span class="p">,</span>
  <span class="s">"request_id"</span> <span class="o">:</span> <span class="mi">1</span>
<span class="p">}</span>
</code></pre>
</div>

<p>フィールド:</p>
<ul>
  <li><code class="highlighter-rouge">topic</code> → パーティションのメタデータを確認するトピック。</li>
  <li><code class="highlighter-rouge">request_id</code> → レスポンスに渡されるリクエストのID。</li>
</ul>

<h5 id="partitionedtopicmetadataresponseコマンド">PartitionedTopicMetadataResponseコマンド</h5>

<p>メタデータ付きのレスポンスの例:</p>

<div class="language-protobuf highlighter-rouge"><pre class="highlight"><code><span class="kd">message</span> <span class="nc">CommandPartitionedTopicMetadataResponse</span> <span class="p">{</span>
  <span class="s">"request_id"</span> <span class="o">:</span> <span class="mi">1</span><span class="p">,</span>
  <span class="s">"response"</span> <span class="o">:</span> <span class="s">"Success"</span><span class="p">,</span>
  <span class="s">"partitions"</span> <span class="o">:</span> <span class="mi">32</span>
<span class="p">}</span>
</code></pre>
</div>

<h2 id="protobufインターフェース">Protobufインターフェース</h2>

<!--

    Licensed to the Apache Software Foundation (ASF) under one
    or more contributor license agreements.  See the NOTICE file
    distributed with this work for additional information
    regarding copyright ownership.  The ASF licenses this file
    to you under the Apache License, Version 2.0 (the
    "License"); you may not use this file except in compliance
    with the License.  You may obtain a copy of the License at

      http://www.apache.org/licenses/LICENSE-2.0

    Unless required by applicable law or agreed to in writing,
    software distributed under the License is distributed on an
    "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
    KIND, either express or implied.  See the License for the
    specific language governing permissions and limitations
    under the License.

-->

<div class="protobuf">
  <div class="container">
    <div class="row">
      <div class="col col-sm-6 padding-0">
        <p class="lead protobuf-title">Messages</p>
        <ul>
           <!-- for message in messages -->
        </ul>
      </div>
      <div class="col col-sm-6 padding-0">
        <p class="lead protobuf-title">Enums</p>
        <ul>
           <!-- for enum in enums -->
        </ul>
      </div>
    </div>
  </div>

  <h3>Protobuf messages</h3>

  <div class="card messages">
     <!-- for message in messages -->
  </div>

  <h3>Protobuf enums</h3>

  <div class="card enums">
     <!-- for enum in enums -->
  </div>
</div>


      </section>
    </article>

    <nav class="toc-bar hidden-md-down col-lg-2">
      
      <div id="toc">
        <h4>Pulsarのバイナリプロトコルの仕様</h4>
      </div>
      
    </nav>
  </div>
</div>

      </main>
    </main>

    <!--

    Licensed to the Apache Software Foundation (ASF) under one
    or more contributor license agreements.  See the NOTICE file
    distributed with this work for additional information
    regarding copyright ownership.  The ASF licenses this file
    to you under the Apache License, Version 2.0 (the
    "License"); you may not use this file except in compliance
    with the License.  You may obtain a copy of the License at

      http://www.apache.org/licenses/LICENSE-2.0

    Unless required by applicable law or agreed to in writing,
    software distributed under the License is distributed on an
    "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
    KIND, either express or implied.  See the License for the
    specific language governing permissions and limitations
    under the License.

-->
<footer class="footer">
  <div class="container">
    <p class="text-center">Copyright 2017 The Apache Software Foundation. All Rights Reserved.</p>
  </div>
</footer>


    
    <script type="text/x-mathjax-config">
      MathJax.Hub.Config({
        tex2jax: {
          skipTags: ['script', 'noscript', 'style', 'textarea', 'pre']
        },
        "HTML-CSS": { scale: 100 }
      });

      MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for(i = 0; i < all.length; i += 1) {
          all[i].SourceElement().parentNode.className += ' has-jax';
        }
      });
    </script>

    <script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    

    
    <!--

    Licensed to the Apache Software Foundation (ASF) under one
    or more contributor license agreements.  See the NOTICE file
    distributed with this work for additional information
    regarding copyright ownership.  The ASF licenses this file
    to you under the Apache License, Version 2.0 (the
    "License"); you may not use this file except in compliance
    with the License.  You may obtain a copy of the License at

      http://www.apache.org/licenses/LICENSE-2.0

    Unless required by applicable law or agreed to in writing,
    software distributed under the License is distributed on an
    "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
    KIND, either express or implied.  See the License for the
    specific language governing permissions and limitations
    under the License.

-->

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-102219959-1', 'auto');
  ga('send', 'pageview');
</script>

    
  </body>
</html>
